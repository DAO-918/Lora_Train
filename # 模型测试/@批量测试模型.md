# 批量测试模型

测试图片保存路径：F:\TEST
模型信息表格的路径：D:\AI Tech\sd-webui-aki\models\model_info.xlsx
"参数"、"底模"、"lora"工作簿中的值、节点名称、节点属性可以写入到List(Dict)的结构中，在发送给comfyui请求时写入参数。

"参数"工作簿：

| 名称       | 值                                                      | 节点名称               | 节点属性      |
| -------- | ------------------------------------------------------ | ------------------ | --------- |
| workflow | SDXL_基础_4Lora.json                                     |                    |           |
| 默认底模     | SD_XL\Ton_XL_blue_pencil-XL_V7.safetensors             | Checkpoint加载器(简易)  | ckpt_name |
| 提示词编号    | as001                                                  |                    |           |
| 正面-1     | (anime, masterpiece),hana suzuki, long hair,           | positive_CLIP文本编码器 | text      |
| 正面-2     | (anime, masterpiece),hana suzuki,                      | positive_CLIP文本编码器 | text      |
| 正面-3     | (anime, masterpiece),hana                              | positive_CLIP文本编码器 | text      |
| 正面-4     | (anime, masterpiece),                                  | positive_CLIP文本编码器 | text      |
| 负面       | longbody,lowres,bad anatomy,bad hands,missing fingers, | negative_CLIP文本编码器 | text      |
| laten_x  | 1024                                                   | 空Latent            | width     |
| laten_y  | 1024                                                   | 空Latent            | height    |
| seed     | 980356707937035                                        | K采样器               | seed      |
| 保存图片路径   | F:\TEST                                                |                    |           |
| 保存图片名称   |                                                        |                    |           |

底模的编号要在模型信息表格的“Stable-diffusion”工作簿的"编号"列中找到，不能用default作为编号

"底模"工作簿：

| 值                                          | 节点名称              | 节点属性      | 编号  | 触发词 | 图片路径 | 展示图片 |
| ------------------------------------------ | ----------------- | --------- | --- | --- | ---- | ---- |
| SD_XL\Ton_XL_blue_pencil-XL_V7.safetensors | Checkpoint加载器(简易) | ckpt_name |     |     |      |      |
| SD_XL\Ton_XL_blue_pencil-XL_V7.safetensors | Checkpoint加载器(简易) | ckpt_name |     |     |      |      |

1. 如果编号和触发词为空：
值要在模型信息表格的“Stable-diffusion”工作簿的"文件名"列中找到，需要用in进行匹配(模型信息表格的文件名的值in"底模"工作簿的"值")
编号要在模型信息表格的“Stable-diffusion”工作簿的"编号"列中找到
编号要在模型信息表格的“Stable-diffusion”工作簿的"触发词"列中找到

2. 保存图片的路径要在原有的基础上加上提示词编号，即F:\TEST\as001。保存图片名称就是"提示词编号_底模的编号"。如果图片存在，就不用对模型进行测试，直接将图片路径填入。如果图片路径不存在图片，对模型进行一次测试，不使用其他的Lora。如果查找到的触发词不为空，就需要在"参数"工作簿中的所有含"正面"的词的值中在最前面添加提示词

“Lora-1”工作簿，Lora工作簿有多个，要同时串联几个Lora就要用到几个Lora工作簿，例如"Lora-1","Lora-2"：

| 值-1                                 | 节点名称-1 | 节点属性-1    | 值-2 | 节点名称-2 | 节点属性-2         | 编号  | 触发词 | 图片路径 | 展示图片 |
| ----------------------------------- | ------ | --------- | --- | ------ | -------------- | --- | --- | ---- | ---- |
| SD_XL_角色\Ton_XL_角色_鈴木羽那.safetensors | Lora1  | lora_name | 1   | Lora1  | strength_model |     |     |      |      |

列名如果前缀是、值、节点名称、节点属性分为一组Dict，可能有多组，需要动态处理

1. 如果编号和触发词为空：
值要在模型信息表格的“Lora”工作簿的"文件名"列中找到，需要用in进行匹配(模型信息表格的文件名的值in"底模"工作簿的"值")
编号要在模型信息表格的“Lora”工作簿的"编号"列中找到
编号要在模型信息表格的“Lora”工作簿的"触发词"列中找到

2. 保存图片的路径要在原有的基础上加上提示词编号，即F:\TEST\as001。保存图片名称就是"提示词编号_底模的编号_Lora1的编号&Lora1的强度"。如果图片存在，就不用对模型进行测试，直接将图片路径填入。如果图片路径不存在图片，对默认底模加Lora进行一次测试。如果查找到的触发词不为空，就需要在"参数"工作簿中的所有含"正面"的词的值中在最前面添加提示词



“测试”工作簿，是将"底模"工作簿和“Lora-1”等多个Lora工作簿中的所有列举的模型，通过组合排列(集合的特性，不分Lora的前后顺序，因为lora的前后顺序不会影响出图的效果)，按树状形式展开：例如工作簿中有："底模"、"Lora-1"、"Lora-2"，组合顺序按照以下方式：
底模1，lora-1-1
底模1，lora-1-1，Lora-2-1
底模1，lora-1-1，Lora-2-2
...
底模1，lora-1-2
底模1，lora-1-2，Lora-2-1
底模1，lora-1-2，Lora-2-2
...
底模2，lora-1-1
底模2，lora-1-1，Lora-2-2

先记录需要测试的模型和Lora有几个，在“测试”工作簿中要写出每一次组合的模型编号、模型名称、Lora编号、Lora名称、Lora强度。然后是图片路径，和展示图片，的表格列名。
保存图片的路径要在原有的基础上加上提示词编号，即F:\TEST\as001。保存图片名称就是"提示词编号_底模的编号_Lora1的编号&Lora1的强度"。如果图片存在，就不用对模型进行测试，直接将图片路径填入。当lora存在两个及以上时的情况，可能会出现已存在的图片路径中的Lora顺序和现有的Lora顺序不同，就需要用代码组合出Lora不同顺序的图片路径去进行尝试。

插入图片要参考# Y_ComfyUI_Test_V1.py 的 reinsert_image 方法

1.如果读取的参数值可以解析为数组，就需要解析成数组。2.lora参数，只有一个组：值、节点名称、节点属性。另外lora强度单独写在后面的列中，不再使用值、节点名称、节点属性的写法，再增加一个列，列名为clip强度，前5列的列名为值、节点名称、节点属性、lora强度、clip强度。["On","None",1,1]需要将值、节点名称、节点属性 中的值替换第二个元素，lora强度替换第三个元素，clip强度替换第四个元素。将完成后的数组作为workflow.set_node_param的第三个参数。3.默认底模的编号也要从要在模型信息表格的“Stable-diffusion”工作簿的"编号"列中找到，不能用default作为编号。此外要注意默认底模的值可能是数组，例如["FLUX\\flux1-dev-fp8.safetensors","fp8_e4m3fn"]，其中字符串含safetensors是底模名称

lora工作簿的第一列开始：值、节点名称、lora强度、clip强度、编号、触发词、图片路径、展示图片
workflow.set_node_param(节点名称, "switch", "On")
workflow.set_node_param(节点名称, "lora_name", 值)
workflow.set_node_param(节点名称, "strength_model", lora强度)
workflow.set_node_param(节点名称, strength_clip, clip强度)

```
"""
方法名称：__init__
功能概述：
    初始化批量测试模型类，设置必要的属性和连接，为后续的模型测试做准备。

数据处理流程：
    1. 数据获取：接收模型信息表格路径和ComfyUI服务器地址作为输入参数
    2. 预处理阶段：
        - 加载Excel模型信息表格，设置data_only=True以获取实际值而非公式
    3. 核心处理：
        - 保存模型信息路径和加载的工作簿对象
        - 保存ComfyUI服务器地址
    4. 结果输出：
        - 创建WebSocket客户端连接，用于与ComfyUI服务器通信

关键数据结构：
    - model_info_wb：存储模型信息的Excel工作簿对象
    - ws_client：WebSocket客户端对象，用于与ComfyUI服务器通信

方法调用关系：
    - 上游依赖：load_workbook 用于加载Excel文件
    - 下游提供：为其他方法提供初始化的属性和连接

异常处理：
    - 无显式异常处理，依赖于load_workbook和ComfyWebSocketClient的异常处理
"""

"""
方法名称：parse_value
功能概述：
    解析参数值，识别并转换可能是JSON数组格式的字符串，使其在程序中可以作为Python列表使用。

数据处理流程：
    1. 数据获取：接收一个任意类型的值作为输入
    2. 预处理阶段：
        - 检查输入值是否为字符串类型
        - 检查字符串是否以"["开头和"]"结尾，判断是否可能是JSON数组
    3. 核心处理：
        - 尝试使用json.loads()将字符串解析为Python对象（通常是列表）
    4. 结果输出：
        - 如果解析成功，返回解析后的Python对象
        - 如果解析失败，记录警告日志并返回原始值

关键数据结构：
    - 输入值：任意类型的数据，可能是字符串、数字、列表等
    - 输出值：如果输入是JSON数组字符串则返回Python列表，否则返回原值

方法调用关系：
    - 上游依赖：json.loads 用于解析JSON字符串
    - 下游提供：为其他方法提供解析后的值，特别是处理Excel中的数组格式数据

异常处理：
    - 捕获JSON解析异常，记录警告日志并返回原始值
"""

"""
方法名称：load_model_info
功能概述：
    从Excel表格中加载模型信息，包括Stable-diffusion模型和Lora模型的详细数据，为后续的模型测试提供数据支持。

数据处理流程：
    1. 数据获取：从初始化时加载的Excel工作簿中读取工作表数据
    2. 预处理阶段：
        - 检查工作簿中是否存在"Stable-diffusion"和"Lora"工作表
    3. 核心处理：
        - 对于每个工作表，提取第一行作为表头
        - 从第二行开始，将每行数据与表头对应，形成字典
        - 筛选出包含"文件名"字段的有效模型数据
    4. 结果输出：
        - 将Stable-diffusion模型数据存储在self.sd_models列表中
        - 将Lora模型数据存储在self.lora_models列表中

关键数据结构：
    - sd_models：列表，每个元素是一个字典，包含Stable-diffusion模型的所有属性
    - lora_models：列表，每个元素是一个字典，包含Lora模型的所有属性

方法调用关系：
    - 上游依赖：初始化时加载的Excel工作簿对象
    - 下游提供：为process_base_models和process_lora_models等方法提供模型数据

异常处理：
    - 当工作表不存在时，记录警告日志并创建空列表
"""

"""
方法名称：process_test_file
功能概述：
    处理测试文件，根据测试文件中的参数和模型信息，生成和保存图片，是整个批量测试流程的主控方法。

数据处理流程：
    1. 数据获取：加载指定的测试Excel文件，读取其中的参数和模型信息
    2. 预处理阶段：
        - 检查必要的工作表（如"参数"）是否存在
        - 检查是否存在"底模"工作表
        - 加载参数工作表中的所有参数
    3. 核心处理：
        - 获取关键参数：工作流文件、默认底模、提示词编号、保存路径
        - 创建保存图片的目录
        - 加载ComfyUI工作流
        - 根据工作表情况，调用不同的处理方法：
          * 处理底模工作表
          * 处理Lora工作表
          * 处理测试组合工作表
    4. 结果输出：
        - 保存更新后的测试文件
        - 在指定路径保存生成的图片

关键数据结构：
    - params：字典，存储参数工作表中的所有参数，每个参数包含值、节点名称、节点属性
    - workflow：ComfyWorkflowWrapper对象，封装了ComfyUI工作流

方法调用关系：
    - 上游依赖：load_workbook用于加载Excel文件，ComfyWorkflowWrapper用于加载工作流
    - 下游调用：process_base_models、process_lora_models、process_test_combinations处理不同类型的模型测试

异常处理：
    - 检查必要工作表和参数是否存在，缺失时记录错误并返回
    - 加载工作流失败时记录错误并返回
"""

"""
方法名称：process_base_models
功能概述：
    处理底模工作表中的模型数据，为每个底模生成图片，并更新工作表中的图片路径。

数据处理流程：
    1. 数据获取：从工作簿中获取"底模"工作表的数据
    2. 预处理阶段：
        - 获取列索引：值、节点名称、节点属性、编号、触发词、图片路径
        - 验证必要的列是否存在
    3. 核心处理：
        - 遍历每一行底模数据
        - 处理模型路径（可能是数组格式）
        - 如果编号或触发词为空，从模型信息表中查找匹配的模型并填充
        - 构建图片保存路径
        - 检查图片是否已存在，不存在则生成新图片：
          * 设置模型参数
          * 添加触发词到提示词中
          * 生成图片并保存
          * 更新工作表中的图片路径
    4. 结果输出：
        - 在指定路径保存生成的图片
        - 更新工作表中的模型编号、触发词和图片路径

关键数据结构：
    - base_sheet：Excel工作表对象，包含底模数据
    - headers：列表，存储工作表的表头

方法调用关系：
    - 上游依赖：self.sd_models提供模型信息，workflow提供工作流操作
    - 下游调用：add_trigger_to_prompts添加触发词，generate_image生成图片

异常处理：
    - 捕获列索引查找异常，记录错误并返回
    - 捕获处理每行数据时的异常，记录错误并继续处理下一行
    - 捕获图片生成和保存过程中的异常，记录错误并继续
"""

"""
方法名称：process_lora_models
功能概述：
    处理Lora工作表中的模型数据，为每个Lora模型与默认底模的组合生成图片，并更新工作表中的图片路径。

数据处理流程：
    1. 数据获取：
        - 获取默认底模信息和编号
        - 从工作簿中获取所有Lora工作表的数据
    2. 预处理阶段：
        - 查找默认底模的编号（从模型信息表或文件名）
        - 获取Lora工作表的列索引
    3. 核心处理：
        - 遍历每个Lora工作表和每一行Lora数据
        - 如果编号或触发词为空，从模型信息表中查找匹配的模型并填充
        - 构建图片保存路径（包含底模编号和Lora编号）
        - 检查图片是否已存在，不存在则生成新图片：
          * 设置默认底模参数
          * 设置Lora参数（处理数组格式的特殊情况）
          * 添加触发词到提示词中
          * 生成图片并保存
          * 更新工作表中的图片路径
    4. 结果输出：
        - 在指定路径保存生成的图片
        - 更新工作表中的Lora编号、触发词和图片路径

关键数据结构：
    - lora_sheet：Excel工作表对象，包含Lora数据
    - headers：列表，存储工作表的表头

方法调用关系：
    - 上游依赖：self.lora_models提供模型信息，workflow提供工作流操作
    - 下游调用：add_trigger_to_prompts添加触发词，generate_image生成图片

异常处理：
    - 检查必要的列是否存在，缺失时记录错误并跳过该工作表
    - 捕获处理Lora参数和生成图片过程中的异常，记录错误并继续
"""

"""
方法名称：process_test_combinations
功能概述：
    处理测试工作簿中的组合测试，生成底模和多个Lora的各种组合，并为每个组合生成图片。

数据处理流程：
    1. 数据获取：
        - 从底模工作表获取所有底模数据
        - 从所有Lora工作表获取Lora数据
    2. 预处理阶段：
        - 构建底模列表和Lora数据字典
        - 如果不存在测试工作表，则创建一个并添加表头
    3. 核心处理：
        - 生成所有可能的组合（调用generate_combinations方法）
        - 遍历每个组合：
          * 写入组合信息到测试工作表
          * 设置底模参数
          * 设置Lora参数
          * 构建图片文件名
          * 检查图片是否已存在，不存在则生成新图片
          * 对于多个Lora的情况，检查不同顺序的组合是否已存在图片
    4. 结果输出：
        - 在指定路径保存生成的图片
        - 更新测试工作表中的图片路径

关键数据结构：
    - base_models：列表，每个元素是一个字典，包含底模的所有属性
    - lora_data：嵌套字典，按Lora编号组织Lora模型数据
    - combinations：列表，每个元素是一个组合的所有参数值

方法调用关系：
    - 上游依赖：generate_combinations生成组合，workflow提供工作流操作
    - 下游调用：add_trigger_to_prompts添加触发词，generate_image生成图片

异常处理：
    - 捕获图片生成和保存过程中的异常，记录错误并继续处理下一个组合
"""

"""
方法名称：generate_combinations
功能概述：
    生成所有可能的底模和Lora组合，为批量测试提供完整的测试集。

数据处理流程：
    1. 数据获取：接收底模列表和Lora数据字典作为输入
    2. 预处理阶段：
        - 创建空的组合列表
    3. 核心处理：
        - 遍历每个底模
        - 为每个底模创建基本组合（只有底模，没有Lora）
        - 为每个底模和单个Lora创建组合
        - 如果有多个Lora，调用add_multi_lora_combinations生成多Lora组合：
          * 2个Lora的组合
          * 3个Lora的组合
          * 4个Lora的组合
    4. 结果输出：
        - 返回包含所有可能组合的列表

关键数据结构：
    - combinations：列表，每个元素是一个列表，包含一个组合的所有参数值
    - base_combo：列表，表示只有底模的基本组合
    - combo：列表，表示包含底模和Lora的组合

方法调用关系：
    - 上游依赖：接收底模和Lora数据作为输入
    - 下游调用：add_multi_lora_combinations生成多Lora组合

异常处理：
    - 无显式异常处理，主要依赖于列表操作的内置异常处理
"""

"""
方法名称：add_multi_lora_combinations
功能概述：
    添加多个Lora的组合到组合列表中，支持生成2个、3个或4个Lora的所有可能组合。

数据处理流程：
    1. 数据获取：接收组合列表、底模、Lora数据和要组合的Lora数量
    2. 预处理阶段：
        - 导入itertools模块用于生成组合
        - 获取所有Lora编号并排序
    3. 核心处理：
        - 使用itertools.combinations生成所有可能的Lora编号组合
        - 对于每个Lora编号组合，获取对应的Lora模型列表
        - 使用itertools.product生成所有可能的Lora模型组合
        - 为每个组合创建一个包含底模和多个Lora的完整组合
    4. 结果输出：
        - 将生成的组合添加到输入的组合列表中

关键数据结构：
    - lora_nums：列表，包含所有Lora编号
    - lora_num_combo：元组，表示一个Lora编号组合
    - lora_options：列表，每个元素是一个Lora模型列表
    - lora_combo：元组，表示一个Lora模型组合
    - lora_info：字典，将Lora编号映射到Lora模型

方法调用关系：
    - 上游依赖：itertools.combinations和itertools.product用于生成组合
    - 下游提供：为generate_combinations方法提供多Lora组合

异常处理：
    - 无显式异常处理，主要依赖于itertools和字典操作的内置异常处理
"""

"""
方法名称：add_trigger_to_prompts
功能概述：
    将触发词添加到工作流中的正面提示词参数中，确保生成的图片包含模型的特定风格或特征。

数据处理流程：
    1. 数据获取：接收工作流对象、参数字典和触发词
    2. 预处理阶段：
        - 无特殊预处理
    3. 核心处理：
        - 遍历所有参数，查找包含"正面"的参数名（表示正面提示词）
        - 获取当前提示词的值
        - 检查触发词是否已存在于提示词中
        - 如果触发词不存在，则在提示词前面添加触发词
        - 更新工作流中的提示词参数
    4. 结果输出：
        - 直接修改工作流对象中的提示词参数，无返回值

关键数据结构：
    - params：字典，包含所有参数，其中可能包含正面提示词参数
    - current_prompt：字符串，当前的提示词
    - new_prompt：字符串，添加触发词后的新提示词

方法调用关系：
    - 上游依赖：workflow.get_node_param和workflow.set_node_param用于获取和设置参数
    - 下游提供：为process_base_models和process_lora_models等方法提供触发词添加功能

异常处理：
    - 无显式异常处理，主要依赖于字符串操作和工作流方法的内置异常处理
"""

"""
方法名称：generate_image
功能概述：
    使用ComfyUI生成图片，将工作流发送到ComfyUI服务器并获取生成的图片数据。

数据处理流程：
    1. 数据获取：接收工作流对象作为输入
    2. 预处理阶段：
        - 无特殊预处理
    3. 核心处理：
        - 调用WebSocket客户端的get_images方法，将工作流发送到ComfyUI服务器
        - 获取返回的图片数据，格式为{node_id: [img_data_list]}
        - 遍历所有节点及其对应的图片数据
        - 返回第一张图片的数据
    4. 结果输出：
        - 返回图片数据（二进制格式），如果生成失败则返回None

关键数据结构：
    - images：字典，键为节点ID，值为图片数据列表
    - img_data：二进制数据，表示一张图片

方法调用关系：
    - 上游依赖：self.ws_client.get_images用于获取图片
    - 下游提供：为process_base_models和process_lora_models等方法提供图片生成功能

异常处理：
    - 捕获所有异常，记录错误日志并返回None
"""

"""
方法名称：reinsert_image
功能概述：
    将生成的图片插入到Excel表格中，使用户可以直接在Excel中查看测试结果，无需打开外部图片文件。

数据处理流程：
    1. 数据获取：接收Excel文件路径作为输入
    2. 预处理阶段：
        - 导入必要的openpyxl模块
        - 加载Excel工作簿
        - 清空所有工作表中已有的图片
    3. 核心处理：
        - 遍历所有工作表和单元格
        - 查找包含.png路径的单元格
        - 对于每个图片路径：
          * 创建压缩版本的图片（如果不存在）
          * 调整图片大小以适应单元格
          * 设置单元格宽高
          * 将图片插入到单元格旁边
        - 设置所有单元格为自动换行和居中对齐
    4. 结果输出：
        - 保存更新后的Excel文件，包含插入的图片

关键数据结构：
    - wb：openpyxl工作簿对象
    - ws：openpyxl工作表对象
    - img：openpyxl图片对象

方法调用关系：
    - 上游依赖：openpyxl模块用于Excel操作，PILImage用于图片处理
    - 下游提供：为main函数提供图片插入功能

异常处理：
    - 捕获图片处理和插入过程中的异常，记录错误日志并继续处理下一个图片
    - 捕获整个过程中的异常，记录错误日志
"""

"""
方法名称：main
功能概述：
    程序的入口点，解析命令行参数并执行批量测试流程。

数据处理流程：
    1. 数据获取：通过argparse解析命令行参数
    2. 预处理阶段：
        - 创建参数解析器并定义参数
        - 解析命令行参数
    3. 核心处理：
        - 创建BatchModelTester对象
        - 加载模型信息
        - 处理测试文件
        - 如果指定了insert-image参数，则将图片插入到Excel表格中
    4. 结果输出：
        - 无直接输出，结果保存在测试文件和生成的图片中

关键数据结构：
    - parser：argparse.ArgumentParser对象，用于解析命令行参数
    - args：包含解析后的命令行参数
    - tester：BatchModelTester对象，执行批量测试

方法调用关系：
    - 上游依赖：argparse模块用于解析命令行参数
    - 下游调用：BatchModelTester的方法执行批量测试

异常处理：
    - 无显式异常处理，主要依赖于BatchModelTester方法的异常处理
"""
```
