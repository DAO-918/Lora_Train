
在子项目文件夹"yaml"下生成一个配置文件，存储基本需要的配置信息
"# 模型训练\toml"存放不同lora训练的配置文件，用于外部的程序调用
角色训练集地址：E:\Design\Character
风格训练集地址：E:\Design\Styles

# Lora_0_Start.py
该代码会移动到风格训练集地址和角色训练集地址下的子文件夹中，然后运行Lora_0_Start.py
角色训练集示例地址：E:\Design\Character\wgi01rl
Character为训练集类型
wgi01rl为项目名称
风格训练集示例地址：E:\Design\Styles\光怪陆离
Styles为训练集类型
光怪陆离为项目名称
1. 在目录下创建一个"训练信息.xlsx"文件，用于记录训练信息, 是否执行，完成时间，完成结果
"步骤"工作簿包含步骤名称、是否执行。步骤名称有：图片尺寸标准化、图片描述生成、图片描述优化、模型Lora训练、模型Lora测试、触发词、提示词编号、训练模板
注意提示词编号一行的是否执行的值是文本
注意训练模板一行的是否执行的值是文本
"提示词"工作簿包含英文提示词、中文提示词、图片预览、图片路径
表格初始化时，代码中会自动添加一个"步骤"工作簿和一个"提示词"工作簿，并初始化行高和列宽

1. 当图片尺寸标准化的是否执行为1时，将代码所在根目录下的"resize"文件夹中地址作为参数运行#Lora_1_图片尺寸-ARB桶.py
2. 当图片描述生成的是否执行为1时，将代码所在根目录下的"resize"文件夹中地址作为参数运行#Lora_2_画面描述-Gemini.py
3. 当图片描述优化的是否执行为1时，将代码所在根目录地址作为参数运行#Lora_3_画面描述优化-Gemini.py
4. 当图片描述优化的是否执行为2时，将代码所在根目录地址作为参数运行#Lora_3_画面描述优化-Gemini.py，并额外执行ai翻译
5. 当模型Lora训练的是否执行为1时，将代码所在根目录地址作为参数运行#Lora_4_模型训练.py
6. 当模型Lora测试的是否执行为1时，将代码所在根目录地址作为参数运行#Lora_5_模型测试.py
只有当上一步的完成结果为"成功"时，才会执行下一步

# Lora_2_画面描述-Gemini.py
注意"resize"文件夹中有多个一级子文件夹，复制图片时也要按照相同的子文件夹位置复制
使用utils的comfy_websocket_wrapper、comfy_workflow_wrapper包
AI提示词 = "Please describe the content of this picture in detail, including the subject, background, color, style, etc. No ambiguous description is needed, brackets are not used to note the uncertain content, and the uncertain content can be omitted."
workflow_copy.set_node_param("Image Load", "image_path", 图片路径)
workflow_copy.set_node_param("提示词", "string", AI提示词)
请求工作流
每5秒或者代码中能告知运行结束后检查一次D:\\Code\\MY_ComfyUI\\# 模型训练"中是否有文件名前缀是picture_prompt_temp的txt文件，如果有，读取文件内容，赋值给picture_prompt，然后删除该文件
设定一个字符串数组error_strings = ["Error", "error", "failed"]
如果字符串数组error_strings中有字符串存在于picture_prompt，重新进行请求，最大重复2次，不退出程序。
每执行一次无论成功还是失败，复制一份图片和与图片文件名同名的txt文档(picture_prompt写入txt)，到gemini文件夹中。如果画面描述生成失败，txt文件名则添加一个后缀"error"，并在"训练信息.xlsx"中记录该步骤的完成结果

第二步：
使用utils的翻译包，如果翻译出现问题切换成另一个翻译包，如果两个重复切换两次都失败，退出程序，在表格中记录完成结果。
将Lora_2_画面描述-Gemini.py生成的txt文件中的内容，填入"训练信息.xlsx"的英文提示词列中
将英文提示词的内容，翻译成中文，填入"训练信息.xlsx"的中文提示词列中
将图片压缩到最长边256px，保存到"训练信息.xlsx"的图片预览列中
将图片路径保存到"训练信息.xlsx"的图片路径列中

只有当所有图片都完成了提示词生成才能在完成情况中输入"成功"，如果没有连接上服务器等前置工作没有完成输入"失败",如果执行过程中有个别图片生成提示词失败，将失败的文件名整理后一起写入单元和

# Lora_3_画面描述优化-Gemini.py
当图片描述优化的是否执行为1时，当如果英文内容发生变化，重新将"训练信息.xlsx"中的英文提示词列中的内容，覆盖到txt文件中
当图片描述优化的是否执行为2时，当中文内容发生变化，请求gemini翻译成英文，参考代码文件Gemini_Flash_Node.py，覆盖到txt文件中

# Lora_4_模型训练.py
"训练模板"的值，找到"# 模型训练\toml"中相应的文件，
修改train_data_dir的值为E:\Design\训练集类型\项目名称\gemini
output_name修改为"项目名称"
output_dir修改为"E:/Design/loras/项目名称"
log_prefix修改为"项目名称"
log_tracker_name修改为"项目名称"
修改后并保存

1. 先确认F:\LoraTrain\A启动脚本.bat，和端口号28000是否开启，进程是否存在
2. 如果未运行，运行F:\LoraTrain\A启动脚本.bat，每10秒检查等待端口号28000，超时2分钟，未开启则退出程序
3. 如果运行，先清除所有"chrome.exe"进程，调用ChromeManager.py包，参考下面的代码：
```python
manager = ChromeManager(config)
driver, wait = manager.open_url(f"http://127.0.0.1:28000/lora/flux.html")
```
导入配置文件按钮：full_xpath：/html/body/div[1]/div/div[2]/div[2]/div[2]/div[2]/button xpath：//*[@id="app"]/div/div[2]/div[2]/div[2]/div[2]/button selector：#app > div > div.example-container > div.right-container > div:nth-child(4) > div:nth-child(2) > button
开始训练按钮：full_xpath：/html/body/div[1]/div/div[2]/div[2]/div[4]/div[1]/button xpath：//*[@id="app"]/div/div[2]/div[2]/div[4]/div[1]/button selector：#app > div > div.example-container > div.right-container > div:nth-child(6) > div:nth-child(1) > button
4. 先点击导入配置文件按钮，等待5s，将修改后保存的toml文件的路径存储到剪贴板中，模拟键盘操作"黏贴"后"回车"，最后点击开始训练按钮
5. 参考#Lora_4_活动监测-LoraTrain.py的代码，先监测是否开始运行，如果180秒内显存和显卡使用率没有达到要求，激活"A启动脚本.bat"窗口，模拟键盘输入"回车"，再次等待180秒，如果180秒内显存和显卡使用率没有达到要求，退出程序，在"训练信息.xlsx"中记录完成结果
6. 如果成功运行，参考#Lora_4_活动监测-LoraTrain.py的代码，对运行活动进行监测，每30秒监测一次，如果连续180秒内显存和显卡使用率没有达到要求，激活"A启动脚本.bat"窗口，模拟键盘输入"回车"，再次等待180秒，重复操作，直到训练完成
当项目名称为wtgl01，时
"E:/Design/loras/项目名称"下有名为"wtgl01.safetensors"的文件时，说明训练成功，退出程序，在"训练信息.xlsx"中记录完成结果


# Lora_5_模型测试.py
根据"训练信息.xlsx"文件中的提示词编号，找到E:\Design\提示词模板.xlsx 该表格的工作簿名称是提示词编号，工作簿内的第一列从第一行开始向下都是提示词，当单元格为空时，停止读取，最多有10个提示词
在E:\Design\训练集类型\项目名称\gemini文件夹下，创建一个"测试.xlsx"文件
创建"参数"工作簿：
下面是固定参数
名称	值	节点名称	节点属性
workflow	#5 提示词单词测试-Unet.json		
默认底模	FLUX\flux1-dev-fp8.safetensors	UNet加载器	unet_name
laten_x	1024	空Latent图像	width
laten_y	1024	空Latent图像	height
seed	441951251478752	K采样器	seed
保存图片路径	F:\TEST		
加上变动参数
提示词编号	"提示词编号"		
提示词数量	"提示词总数"	提示词数量	int
正面-1	"提示词1"	String-1	string
正面-2	"提示词2"	String-2	string
正面-3	"提示词3"	String-3	string
正面-4	"提示词4"	String-4	string
有几个提示词，就有几个正面-*

创建"Lora-1"工作簿：
值	节点名称	lora强度	clip强度	编号	触发词	图片路径	展示图片
在"E:/Design/loras/项目名称"下拓展名为safetensors的文件，将路径中的"E:/Design/loras/"替换为空字符串，如果文件名没有后缀排最后一行	Load LoRA-1	1	1	项目名称-文件名后缀取最后三位数，如果没有后缀用last作为后缀	触发词(训练信息.xlsx中的触发词)

表格生成后使用batch_model_test.py进行测试



